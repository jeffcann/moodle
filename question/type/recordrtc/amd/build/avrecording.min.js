define ("qtype_recordrtc/avrecording",["core/log","core/modal_factory"],function(a,b){function c(){if(!(navigator.mediaDevices&&window.MediaRecorder)){return"nowebrtc"}if(!("https:"===location.protocol||-1!==location.host.indexOf("localhost"))){return"nothttps"}return"ok"}function d(b,c,d,e,f,g,h,i,j){var C=this,D=null,E=null,F=[],G=0,H=0,I=0;e.addEventListener("click",function(b){a.debug("Start/stop button clicked.");b.preventDefault();switch(e.dataset.state){case"new":case"recorded":k();break;case"recording":n();break;}});this.uploadMediaToServer=function(){z("uploadpreparing");f.classList.remove("hide");d.classList.add("hide");A(!1);var a=new XMLHttpRequest;a.open("GET",c.src);a.responseType="blob";a.addEventListener("load",u);a.send()};function k(){e.disabled=!0;if(b.hidePlayerDuringRecording){c.parentElement.classList.add("hide");d.classList.remove("hide");d.textContent=""}else{c.parentElement.classList.remove("hide");d.classList.add("hide")}f.classList.add("hide");e.classList.remove("btn-outline-danger");e.classList.add("btn-danger");F=[];G=0;a.debug("Audio question: Starting recording with media constraints");a.debug(b.mediaConstraints);navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(l).catch(p)}function l(b){D=b;var d=B();a.debug("Audio question: creating recorder with opptions");a.debug(d);E=new MediaRecorder(b,d);E.ondataavailable=m;E.onstop=o;a.debug("Audio question: starting recording.");E.start(1e3);c.srcObject=b;c.setAttribute("muted","");e.dataset.state="recording";q();A(!1);e.disabled=!1;e.focus()}function m(b){a.debug("Audio question: chunk of "+b.data.size+" bytes received.");G+=b.data.size;if(0<=j.maxUploadSize&&G>=j.maxUploadSize){if(!localStorage.getItem("alerted")){localStorage.setItem("alerted","true");n();i.showAlert("nearingmaxsize")}else{localStorage.removeItem("alerted")}}F.push(b.data);if("undefined"!=typeof M.core_formchangechecker&&!window.location.pathname.endsWith("/question/preview.php")){M.core_formchangechecker.set_form_changed()}}function n(){e.disabled=!0;setTimeout(function(){e.disabled=!1},1e3);r();e.innerText=M.util.get_string("recordagain","qtype_recordrtc");e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");A(!0);a.debug("Audio question: stopping recording.");E.stop();for(var b=D.getTracks(),c=0;c<b.length;c++){b[c].stop()}}function o(){a.debug("Audio question: recording stopped.");var b=new Blob(F,{type:E.mimeType});c.srcObject=null;c.src=URL.createObjectURL(b);c.muted=!1;c.controls=!0;c.parentElement.classList.remove("hide");d.classList.add("hide");c.focus();e.innerText=M.util.get_string("recordagain","qtype_recordrtc");e.disabled=!1;e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");e.dataset.state="recorded";if(0<F.length){i.notifyRecordingComplete(C)}}function p(b){a.debug("Audio question: error received");a.debug(b);e.innerText=M.util.get_string("recordingfailed","qtype_recordrtc");e.disabled=!1;e.classList.remove("btn-danger");e.classList.add("btn-outline-danger");e.dataset.state="new";var c="gum"+b.name.replace("Error","").toLowerCase();i.showAlert(c)}function q(){H=j.timeLimit+1;e.innerHTML=M.util.get_string("stoprecording","qtype_recordrtc")+" (<span></span>)";s();I=setInterval(s,1e3)}function r(){if(0!==I){clearInterval(I);I=0}}function s(){H-=1;var a=H%60,b=Math.round((H-a)/60);e.querySelector("span").innerText=t(b)+":"+t(a);if(0===H){n()}}function t(a){var b=a+"";if(2>b.length){return"0"+b}else{return b}}function u(a){var b=a.target;if(200!==b.status){return}var c=b.response,d=new FormData;d.append("repo_upload_file",c,h);d.append("sesskey",M.cfg.sesskey);d.append("repo_id",j.uploadRepositoryId);d.append("itemid",j.draftItemId);d.append("savepath","/");d.append("ctx_id",j.contextId);d.append("overwrite",1);var e=new XMLHttpRequest;e.addEventListener("readystatechange",v);e.upload.addEventListener("progress",w);e.addEventListener("error",x);e.addEventListener("abort",y);e.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload");e.send(d)}function v(a){var b=a.target;if(4===b.readyState&&200===b.status){z("uploadcomplete")}else if(404===b.status){z("uploadfailed404")}A(!0)}function w(a){z("uploadprogress",Math.round(100*(a.loaded/a.total))+"%")}function x(){z("uploadfailed")}function y(){z("uploadaborted")}function z(b,c){f.querySelector("small").innerText=M.util.get_string(b,"qtype_recordrtc",c)}function A(a){g.forEach(function(b){b.disabled=!a})}function B(){var a={audioBitsPerSecond:parseInt(j.audioBitRate,10)};if("video"===b.name){a.videoBitsPerSecond=parseInt(j.videoBitRate,10)}for(var c=0;c<b.mimeTypes.length;c++){if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}}return a}}var f={name:"audio",hidePlayerDuringRecording:!0,mediaConstraints:{audio:!0},mimeTypes:["audio/webm;codecs=opus","audio/ogg;codecs=opus"]},g={name:"video",hidePlayerDuringRecording:!1,mediaConstraints:{audio:!0,video:{width:{ideal:640},height:{ideal:480}}},mimeTypes:["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]};function e(a,e,h){var k=document.getElementById(a),l=c();if("nothttps"===l){k.querySelector(".https-warning").classList.remove("hide");return}else if("nowebrtc"===l){k.querySelector(".no-webrtc-warning").classList.remove("hide");return}var m;if("audio"===h){m=f}else{m=g}var n=k.querySelectorAll(".record-widget");n.forEach(function(a){var b=a.querySelector(".record-button button"),c=a.querySelector(".media-player "+h),f=a.querySelector(".no-recording-placeholder"),g=a.querySelector(".saving-message"),k=a.querySelectorAll("input.submit[type=submit]"),l=a.dataset.recordingFilename;this.showAlert=i;this.notifyRecordingComplete=j;new d(m,c,f,b,g,k,l,this,e)});function i(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){a.show();return a})}function j(a){a.uploadMediaToServer()}}return{init:function init(a,b,c){M.util.js_pending("init-"+a);new e(a,b,c);M.util.js_complete("init-"+a)}}});
//# sourceMappingURL=avrecording.min.js.map
